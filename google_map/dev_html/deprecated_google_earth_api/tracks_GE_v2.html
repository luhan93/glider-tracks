<!-- tracks3d.html 
Modified from Google Earth API Examples for Multiple Glider Tracks 
http://earth-api-samples.googlecode.com/svn/trunk/examples/kml-fetch-checkboxes.html

loads kml generated by parsing localuser mail for current surface fix, glider mission and
other info wanted to display on google earth

Used Goggle Earth so we can add other layers and data via kml files 
Can scale icons in Google Earth and not in Google Maps.
Can use time and ocean views below sea-level.

Added timespan to glider track
Added other layers:
    - 6km hourly HFR vectors -- subsampled for region to draw more quickly
    - 6km 25 hour avg HFR vectors -- subsampled for region to draw more quickly
    - NDBC Marine Obs
    - Long Bay Moorings
Tidied up with a table

You are free to copy and use this sample in accordance with the terms of the
Apache license (http://www.apache.org/licenses/LICENSE-2.0.html)
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <!-- Refresh the page every 1800 seconds (30 minutes) -->
    <meta http-equiv="Refresh" content="1800; url=http://dockserver.marine.unc.edu/realtime/tracks/" />
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="./css/styles.css"></link>
    <title>Glider Tracks</title>
   <script type="text/javascript" src="kml_href_array.js?W"></script>
   <script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAA747JuuldtzBnLspWkFFDeBSgCKDHVpFgZ1Nng_oNKKqex1JsFBSi5tYx5nsf6PGk-9RU9O4N-cyitw"> </script>
    <script type="text/javascript">
      function addLayerButton(caption, clickHandler) {
        var btn = document.createElement('input');
        btn.type = 'button';
        btn.value = caption;
        
        if (btn.attachEvent)
          btn.attachEvent('onclick', clickHandler);
        else
          btn.addEventListener('click', clickHandler, false);

        // add the button to the Layer UI
        document.getElementById('layer-ui').appendChild(btn);
      }
      
      function addLayerUIHtml(html) {
        document.getElementById('layer-ui').innerHTML += html;
      }
    </script>
    <script type="text/javascript">
    var ge;
    
    // var currentKmlObjects is initialied in js_kml_arrary.js source
    
    google.load("earth", "1");
    
    function init() {
      google.earth.createInstance('map3d', initCallback, failureCallback);
    
      addLayerUIHtml(
        '<input type="checkbox" id="kml-ramses-check" onclick="toggleKml(\'ramses\');"/><label for="kml-ramses-check">Ramses </label><br/>' +
        '<input type="checkbox" id="kml-pelagia-check" onclick="toggleKml(\'pelagia\');"/><label for="kml-pelagia-check">Pelagia </label><br/>' +
        '<input type="checkbox" id="kml-moorings-check" onclick="toggleKml(\'moorings\');" checked/><label for="kml-moorings-check">LB Moorings </label><br/>' +
        '<input type="checkbox" id="kml-hfrhr-check" onclick="toggleKml(\'hfrhr\');"/><label for="kml-hfrhr-check">HFR 6km, Hourly </label><br/>' +
        '<input type="checkbox" id="kml-hfr25hr-check" onclick="toggleKml(\'hfr25hr\');"/><label for="kml-hfr25hr-check">HFR 6km, 25 Hour Avg </label><br/>' +
        '<input type="checkbox" id="kml-ndbc-check" onclick="toggleKml(\'ndbc\');"/><label for="kml-ndbc-check">NDBC </label><br/>' 
      );
    }
    
    function initCallback(instance) {
      ge = instance;
      ge.getWindow().setVisibility(true);

      ge.getOptions().setStatusBarVisibility(true);
      ge.getOptions().setScaleLegendVisibility(true);
      ge.getOptions().setUnitsFeetMiles(false);
    
      // add a navigation control
      ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
    
      // add some layers
      ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);
      ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS, true);
    
	// fly instantly to position
	ge.getOptions().setFlyToSpeed(ge.SPEED_TELEPORT);  

	// fly to Long Bay, NC
  	var lb = ge.createLookAt('');
  	lb.set(33.12, -78.3,
    	0, // altitude
    	ge.ALTITUDE_ABSOLUTE,
    	0, // heading
    	0, // straight-down tilt
    	200000 // range (inverse of zoom)
    	);

	// fly to Tower R2 SKIO, GA
  	var r2 = ge.createLookAt('');
  	r2.set(31.375, -80.567,
    	0, // altitude
    	ge.ALTITUDE_ABSOLUTE,
    	0, // heading
    	0, // straight-down tilt
    	100000 // range (inverse of zoom)
    	);

	ge.getView().setAbstractView(lb);

      // if the page loaded with checkboxes checked, load the appropriate
      // KML files
      if (document.getElementById('kml-ramses-check').checked)
        loadKml('ramses');
      if (document.getElementById('kml-pelagia-check').checked)
        loadKml('pelagia');
      if (document.getElementById('kml-ndbc-check').checked)
        loadKml('ndbc');
      if (document.getElementById('kml-moorings-check').checked)
        loadKml('moorings');

      //if layers other than routes are checked, uncheck them
      // if (document.getElementById('kml-pelagia-check').checked)
      //   document.getElementById('kml-pelagia-check').checked = false;

      document.getElementById('installed-plugin-version').innerHTML =
        ge.getPluginVersion().toString();
    }
    
    function failureCallback(errorCode) {
    }
    
    function toggleKml(name) {

      // remove the old KML object if it exists
      if (currentKmlObjects[name]) {
        ge.getFeatures().removeChild(currentKmlObjects[name]);
        currentKmlObject = null;
      }
    
      // if the checkbox is checked, fetch the KML and show it on Earth
      var kmlCheckbox = document.getElementById('kml-' + name + '-check');
      if (kmlCheckbox.checked)
        loadKml(name);
    }
    
    function loadKml(name) {
      var kmlUrl = kmlArray[name][1];
    
      // fetch the KML
      google.earth.fetchKml(ge, kmlUrl, function(kmlObject) {
        // NOTE: we still have access to the 'file' variable (via JS closures)
    
        if (kmlObject) {
          // show it on Earth
          currentKmlObjects[name] = kmlObject;
          ge.getFeatures().appendChild(kmlObject);
	  if (kmlObject.getAbstractView())
	      ge.getView().setAbstractView(kmlObject.getAbstractView());

        } else {
          // bad KML
          currentKmlObjects[name] = null;
    
          // wrap alerts in API callbacks and event handlers
          // in a setTimeout to prevent deadlock in some browsers
          setTimeout(function() {
            alert('No KML found for layer name ' + name + ' at '+ kmlUrl);
          }, 0);
    
          // uncheck the box
          document.getElementById('kml-' + name + '-check').checked = '';
        }
      });

     // listen for click on the window (look specifically for point placemarks)
     google.earth.addEventListener(ge.getWindow(), 'click', function(event) {
       if (event.getTarget().getType() == 'KmlPlacemark' &&
           event.getTarget().getGeometry().getType() == 'KmlPoint') {
         // prevent default ballon
         event.preventDefault();

         // var text = 'cliked on an ICon Placemkarker';
         var text = event.getTarget().getDescription();
	 showInContentWindow(text);
      }

     // wrap alerts in API callbacks and event handlers
     // in a setTimeout to prevent deadlock in some browsers
     // setTimeout(function() {
     //  alert(text);
     // }, 0);

     });

     function showInContentWindow(text) {
       var sidediv = document.getElementById('content_window');
       sidediv.innerHTML = text;

     }	

    }
    
    </script>
  </head>
  <body onload="init()" style="font-family: arial, sans-serif; font-size: 13px; border: 0;">
    <h3>Glider Tracks:</h3>
    <div style="clear: both;"></div>
  
    <div id="ui">
    <table>
    <tr>
       <td id="layer-ui" style="text-align:left;vertical-align:top;width:180px;"></td>
       <td id="map3d" style="height: 750px; width: 700px;"></td>
       <td id="content_window" style="vertical-align:top;"> </td>
       <!-- <td id="content_window" style="position: absolute; left: 820px; top: 0;"> </td> -->
    </tr>
    </table>
    </div>
    <dl><dt>Installed Plugin Version:</dt><dd id="installed-plugin-version">...</dd></dl>

  </body>
</html>